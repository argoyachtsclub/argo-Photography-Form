<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 亞果遊艇會攝影需求-需求單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxsf6VgqXjM3wu5To3RUbb-DOPi4i8kay_j4F_Z-Q_TXG0zlx59BNOgAPtQPfNWhQ56/exec";
        const DRIVE_FOLDER_ID = "15hRF92wAjBwkSijr41AQbkGGQASQCo8u";

        function getMinDeadline() {
            let date = new Date();
            let count = 0;
            while (count < 7) {
                date.setDate(date.getDate() + 1);
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    count++;
                }
            }
            return date;
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const compressImage = (file) => new Promise((resolve) => {
            if (!file.type.startsWith('image/')) return resolve(file);
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_SIZE = 1200;
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
                };
            };
        });

        window.validateDate = function() {
            const dateInput = document.getElementById('deadline');
            const selectedDate = new Date(dateInput.value);
            const minDate = getMinDeadline();
            minDate.setHours(0,0,0,0);
            if (dateInput.value) {
                const day = selectedDate.getDay();
                if (day === 0 || day === 6) {
                    alert("⚠️ 拍攝日期不能選擇週六或週日。");
                    dateInput.value = "";
                    return;
                }
                if (selectedDate < minDate) {
                    alert("⚠️ 攝影需求需預留至少 7 個工作天。");
                    dateInput.value = "";
                    return;
                }
            }
        };

        window.handleSubmit = async function() {
            const btn = document.getElementById('finalSubmit');
            const fields = ['dept', 'applicant', 'ext', 'deadline', 'location', 'items', 'usage', 'qty_v', 'qty_h', 'helper'];
            let formData = {};
            let firstErrorEl = null;

            fields.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value.trim()) {
                    el.classList.add('border-red-500', 'bg-red-50');
                    if (!firstErrorEl) firstErrorEl = el;
                } else {
                    el.classList.remove('border-red-500', 'bg-red-50');
                    formData[id] = el.value.trim();
                }
            });

            const imgFileEl = document.getElementById('imgFile');
            const uploadCard = imgFileEl.parentElement;
            if (imgFileEl.files.length === 0) {
                uploadCard.classList.add('border-red-500', 'bg-red-50');
                if (!firstErrorEl) firstErrorEl = uploadCard;
                alert("⚠️ 請上傳至少一張風格參考圖（必要填寫）。");
            } else {
                uploadCard.classList.remove('border-red-500', 'bg-red-50');
            }

            const hStart = document.getElementById('shootH_start').value;
            const mStart = document.getElementById('shootM_start').value;
            const hEnd = document.getElementById('shootH_end').value;
            const mEnd = document.getElementById('shootM_end').value;
            formData.shootTime = `${hStart}:${mStart}~${hEnd}:${mEnd}`;

            if (firstErrorEl) {
                firstErrorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if (firstErrorEl.tagName !== 'DIV') firstErrorEl.focus();
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>處理中...';

                formData.targetFolderId = DRIVE_FOLDER_ID;
                const textFileEl = document.getElementById('textFile');
                if (textFileEl.files.length > 0) {
                    const tFile = textFileEl.files[0];
                    formData.textFileName = tFile.name;
                    formData.textFileBody = await toBase64(tFile);
                }

                formData.images = [];
                const imgFiles = Array.from(imgFileEl.files);
                for (let i = 0; i < imgFiles.length; i++) {
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>圖片 (${i+1}/${imgFiles.length})...`;
                    const compressed = await compressImage(imgFiles[i]);
                    const b64 = await toBase64(compressed);
                    formData.images.push({ mime: "image/jpeg", body: b64 });
                }

                btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>傳送中...';
                
                await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                alert("✅ 攝影需求已成功同步至系統！\n請記得下載 PDF 並完成後續簽核作業。");
                btn.innerHTML = '提交完成';
                btn.classList.replace('bg-[#002856]', 'bg-green-600');
                setTimeout(() => location.reload(), 3000);

            } catch (err) {
                console.error(err);
                alert("❌ 送出失敗，但您可以先下載 PDF 辦理簽核。\n錯誤資訊: " + err.message);
                btn.disabled = false;
                btn.innerHTML = '重新送出';
            }
        };

        window.handleFileSelect = function(inputId, spanId) {
            const input = document.getElementById(inputId);
            const span = document.getElementById(spanId);
            if (input.files.length > 0) {
                span.innerText = input.files.length === 1 ? "已選: " + input.files[0].name : "已選 " + input.files.length + " 個檔案";
                span.classList.add('text-green-600', 'font-bold');
                input.parentElement.classList.remove('border-red-500', 'bg-red-50');
            }
        };

        window.downloadPDF = function() {
            const element = document.getElementById('pdfArea');
            const applicant = document.getElementById('applicant').value || '未命名';
            const date = new Date().toISOString().slice(0, 10);
            const btn = document.getElementById('btnDownload');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>生成中...';
            btn.disabled = true;

            const opt = {
                margin: 0, 
                filename: `攝影需求單_${applicant}_${date}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    scrollY: 0,
                    y: 0,
                    removeContainer: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: 'avoid-all' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = '<i class="fas fa-file-pdf mr-1"></i>下載 PDF';
                btn.disabled = false;
            });
        };

        window.onload = function() {
            document.getElementById('todayDate').value = new Date().toLocaleDateString('zh-TW');
            const minDate = getMinDeadline();
            const yyyy = minDate.getFullYear();
            const mm = String(minDate.getMonth() + 1).padStart(2, '0');
            const dd = String(minDate.getDate()).padStart(2, '0');
            document.getElementById('deadline').setAttribute('min', `${yyyy}-${mm}-${dd}`);
            
            const hStarts = document.getElementById('shootH_start');
            const hEnds = document.getElementById('shootH_end');
            for(let i=8; i<=21; i++){
                let optStart = document.createElement('option');
                let optEnd = document.createElement('option');
                let val = String(i).padStart(2, '0');
                
                optStart.value = val; optStart.text = val;
                optEnd.value = val; optEnd.text = val;
                
                if(i===14) optStart.selected = true;
                if(i===15) optEnd.selected = true;
                
                hStarts.add(optStart);
                hEnds.add(optEnd);
            }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; }
        .upload-card { border: 2px dashed #cbd5e1; transition: 0.3s; cursor: pointer; }
        .upload-card:hover { border-color: #B69A7D; background-color: #fffaf5; }
        .text-argo-brown { color: #B69A7D; }
        .bg-argo-warm { background-color: #FDF9F3; }
        .border-argo-brown { border-color: #B69A7D; }
        .notice-badge {
            background-color: #FFF1F2;
            border: 1px solid #E11D48;
            color: #BE123C;
            border-radius: 4px;
            padding: 2px 8px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #B69A7D;
            box-shadow: 0 0 0 2px rgba(182, 154, 125, 0.15);
        }
        select { -webkit-appearance: none; appearance: none; }
        
        #pdfArea { 
            margin: 0 !important; 
            padding: 0 !important; 
            border: none !important; 
        }

        @media print {
            .data-html2canvas-ignore { display: none !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-[#002856] text-white p-4 shadow-lg border-b-4 border-[#B69A7D] data-html2canvas-ignore">
        <div class="max-w-4xl mx-auto flex items-center space-x-4">
            <i class="fas fa-camera text-[#B69A7D] text-2xl"></i>
            <div>
                <h1 class="text-lg font-bold tracking-widest uppercase">ARGO YACHT CLUB</h1>
                <p class="text-[8px] text-[#B69A7D] font-medium tracking-[0.2em] uppercase opacity-80">Photography Request System</p>
            </div>
        </div>
    </header>

    <div class="py-0 md:py-6">
        <main class="max-w-4xl mx-auto px-0 md:px-6">
            <div id="pdfArea" class="bg-white">
                <div class="border border-slate-100 p-6 space-y-6">
                    <div class="text-center border-b pb-4">
                        <h2 class="text-xl font-bold text-[#002856]">攝影需求申請單</h2>
                        <p class="text-[9px] text-[#B69A7D] font-bold uppercase tracking-widest mt-0.5">Photography Request Form</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">委託部門 Department</label>
                            <select id="dept" class="w-full rounded-lg p-2 border border-slate-200 bg-white text-xs outline-none">
                                <option>行銷部 Marketing</option>
                                <option>業務部 Sales</option>
                                <option>會員服務部 Membership</option>
                                <option>亞果薈 Argo House</option>
                                <option>維護課 Maintenance</option>
                                <option>住服課 Service</option>
                                <option>船艇中心 Marine Center</option>
                                <option>管理部 Administration</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">* 申請人 Applicant</label>
                            <input type="text" id="applicant" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">* 拍攝日期 Date</label>
                            <input type="date" id="deadline" onchange="validateDate()" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">* 聯絡分機 Ext.</label>
                            <input type="text" id="ext" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none" placeholder="#123">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">* 拍攝地點 Location</label>
                            <input type="text" id="location" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none" placeholder="例：台南安平碼頭、亞果薈包廂">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">* 拍攝時間 Time (間距)</label>
                            <div class="flex items-center space-x-1">
                                <div class="flex-1 flex items-center space-x-1 border border-slate-200 rounded-lg px-1">
                                    <select id="shootH_start" class="flex-1 p-1.5 text-xs text-center outline-none bg-transparent"></select>
                                    <span class="text-[10px] font-bold text-slate-300">:</span>
                                    <select id="shootM_start" class="flex-1 p-1.5 text-xs text-center outline-none bg-transparent">
                                        <option value="00">00</option>
                                        <option value="30">30</option>
                                    </select>
                                </div>
                                <span class="text-xs font-bold text-slate-400">~</span>
                                <div class="flex-1 flex items-center space-x-1 border border-slate-200 rounded-lg px-1">
                                    <select id="shootH_end" class="flex-1 p-1.5 text-xs text-center outline-none bg-transparent"></select>
                                    <span class="text-[10px] font-bold text-slate-300">:</span>
                                    <select id="shootM_end" class="flex-1 p-1.5 text-xs text-center outline-none bg-transparent">
                                        <option value="00">00</option>
                                        <option value="30">30</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase">* 需求內容與品項詳述 Description</label>
                        <textarea id="items" rows="3" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none" placeholder="請詳述拍攝品項、期望風格與構圖描述..."></textarea>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="space-y-1 col-span-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">* 使用用途 Purpose</label>
                            <input type="text" id="usage" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none" placeholder="例：FB貼文、官網素材">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">直式張數 Portrait</label>
                            <input type="number" id="qty_v" value="0" min="0" max="5" oninput="if(this.value>5)this.value=5" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none">
                            <p class="text-[9px] text-slate-400 mt-0.5">最多 5 張</p>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">橫式張數 Landscape</label>
                            <input type="number" id="qty_h" value="0" min="0" max="5" oninput="if(this.value>5)this.value=5" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none">
                            <p class="text-[9px] text-slate-400 mt-0.5">最多 5 張</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">* 現場協助人員 On-site Support</label>
                            <input type="text" id="helper" class="w-full rounded-lg p-2 border border-slate-200 text-xs outline-none" placeholder="需指派一位同仁">
                        </div>
                        <div class="space-y-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase">填表日期 Form Date</label>
                            <input type="text" id="todayDate" readonly class="w-full bg-slate-50 rounded-lg p-2 border-none text-slate-400 text-xs">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 data-html2canvas-ignore">
                        <div class="upload-card rounded-xl p-3 text-center" onclick="document.getElementById('textFile').click()">
                            <i class="fas fa-file-word text-[#002856] text-lg mb-1"></i>
                            <p class="text-[10px] font-bold">說明檔/文案上傳 Attachment</p>
                            <input type="file" id="textFile" class="hidden" onchange="handleFileSelect('textFile', 'textName')">
                            <p id="textName" class="text-[9px] text-slate-400">Word / PDF</p>
                        </div>
                        <div class="upload-card rounded-xl p-3 text-center" onclick="document.getElementById('imgFile').click()">
                            <i class="fas fa-images text-[#B69A7D] text-lg mb-1"></i>
                            <p class="text-[10px] font-bold">* 風格參考圖上傳 Reference</p>
                            <input type="file" id="imgFile" class="hidden" multiple accept="image/*" onchange="handleFileSelect('imgFile', 'imgName')">
                            <p id="imgName" class="text-[9px] text-slate-400 font-bold text-red-500">此為必要填寫項</p>
                        </div>
                    </div>
                </div>

                <div class="bg-argo-warm border-l-8 border-argo-brown shadow-md overflow-hidden border border-[#E6D5C3]">
                    <div class="p-5 pb-2">
                        <div class="flex items-center justify-between mb-3 pl-8">
                            <div class="flex items-center">
                                <div class="bg-argo-brown rounded-full w-5 h-5 flex items-center justify-center mr-2">
                                    <i class="fas fa-info text-white text-[10px]"></i>
                                </div>
                                <h4 class="text-sm font-black text-argo-brown tracking-widest">攝影需求注意事項</h4>
                            </div>
                            <div class="notice-badge">
                                <i class="fas fa-print mr-1.5 text-[10px]"></i>
                                <span class="text-[10px]">印出紙本簽核後送至行銷部</span>
                            </div>
                        </div>
                        <div class="w-full pl-16 pr-4">
                            <ol class="text-[11px] text-[#8C7355] leading-relaxed list-decimal list-outside space-y-1 font-bold text-left">
                                <li class="pl-1">拍攝需求需預留至少 <span class="text-argo-brown border-b border-argo-brown">7 天</span>(不含假日)之準備期。</li>
                                <li class="pl-1">申請單位需確保拍攝當日產品、場景已準備就緒。</li>
                                <li class="pl-1">行銷部僅負責“<span class="text-argo-brown">攝影調色執行</span>”，不協助行政流程。</li>
                                <li class="pl-1">特殊急件請事先告知。</li>
                                <li class="pl-1">若需拍攝手模請申請單位自行尋找同仁。</li>
                                <li class="pl-1">若天氣不佳，行銷部有權更改拍攝日期。</li>
                                <li class="pl-1">攝影內容依需求單為主，現場異動需評估時程。</li>
                            </ol>
                        </div>
                    </div>
                    <div class="p-8 pt-4 bg-white/40">
                        <div class="flex justify-between items-center space-x-12 mt-6">
                            <div class="flex-1 text-center">
                                <p class="text-[10px] font-black text-[#A69177] uppercase mb-12 tracking-widest">申請人簽名 (Applicant)</p>
                                <div class="border-b-2 border-dashed border-[#D4C3B0] w-full"></div>
                            </div>
                            <div class="flex-1 text-center">
                                <p class="text-[10px] font-black text-[#002856] uppercase mb-12 tracking-widest">主管核准簽核 (Approval)</p>
                                <div class="border-b-4 border-[#002856] w-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="buttonGroup" class="grid grid-cols-2 gap-3 px-4 md:px-0 mt-6 data-html2canvas-ignore">
                <button type="button" id="btnDownload" onclick="downloadPDF()" class="border-2 border-[#B69A7D] text-[#B69A7D] font-bold py-3.5 rounded-xl hover:bg-[#fffaf5] transition-all flex items-center justify-center shadow-sm text-sm">
                    <i class="fas fa-file-pdf mr-2"></i> 下載 PDF 簽核單
                </button>
                <button type="button" id="finalSubmit" onclick="handleSubmit()" class="bg-[#002856] text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-900 transition-all tracking-widest uppercase cursor-pointer text-sm">
                    <i class="fas fa-check mr-2"></i> 確認送出
                </button>
            </div>
        </main>
    </div>

    <footer class="text-center text-slate-400 text-[8px] py-10 data-html2canvas-ignore">
        © 2026 ARGO YACHT CLUB. ALL RIGHTS RESERVED.
    </footer>
</body>
</html>
